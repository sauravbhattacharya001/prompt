name: Publish to NuGet

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version_override:
        description: "Override package version (leave empty to use csproj version)"
        required: false
        type: string

permissions:
  contents: read
  packages: write

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  publish:
    name: Build & Publish
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Run tests
        run: dotnet test --no-restore -c Release --logger "trx"

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version_override }}" ]; then
            echo "version=${{ inputs.version_override }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            # Strip leading 'v' from tag (v3.1.0 -> 3.1.0)
            TAG="${{ github.event.release.tag_name }}"
            echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=" >> "$GITHUB_OUTPUT"
          fi

      - name: Pack NuGet package
        run: |
          VERSION_ARG=""
          if [ -n "${{ steps.version.outputs.version }}" ]; then
            VERSION_ARG="/p:Version=${{ steps.version.outputs.version }}"
          fi
          dotnet pack src/Prompt.csproj \
            -c Release \
            --no-build \
            -o ./artifacts \
            $VERSION_ARG

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./artifacts/*.nupkg

      - name: Publish to NuGet.org
        if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate

      - name: Publish to GitHub Packages
        if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --source "https://nuget.pkg.github.com/sauravbhattacharya001/index.json" \
            --skip-duplicate
